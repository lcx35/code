{% extends "base.html" %}
{% block content %}

            <div class="row">
                <div class="col-lg-12">
                    <h1 class="page-header">域名</h1>
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            域名列表<br />
                             <a href="/domain/add"> 添加域名</a>
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-body">
                            <div class="dataTable_wrapper">
                                <table class="table table-striped table-bordered table-hover" id="dataTables-example">
                                    <thead>
                                        <tr>
                                            <th>域名</th>
                                            <th>当前版本</th>
                                            <th>最新版本</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
				{% for domain in domains %}
                                        <tr class="odd gradeX">
                                            <td>{{ domain.domain }}</td>
                                            <td>{{ domain.c_version }}</td>
                                            <td>{{ domain.n_version }}</td>
                                            <td id="{{ domain.domain }}">
						<a title="查看|编辑" class="fa fa-edit fa-fw" href="/domain/edit?d={{ domain.domain }}"></a>
						<a title="部署" class="fa fa-upload fa-fw" href="javascript:void(0);" onclick="post('/domain/deploy',{domain :{{ domain.domain }},action:0})"></a>
						<a title="回滚" class="fa fa-arrow-left fa-fw" href="javascript:void(0);" onclick="rollback('{{ domain.domain }}')"></a>
						<a title="删除" class="fa fa-trash-o fa-fw" href="/domain/del?d={{ domain.domain }}"></a>
					    </td>
                                        </tr>
				{% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <!-- /.table-responsive -->
 
                        </div>
                        <!-- /.panel-body -->
                    </div>
                    <!-- /.panel -->
                </div>
                <!-- /.col-lg-12 -->
            </div>
 
           
<script>
function rollback(id)
{
var obj=document.getElementById(id);
obj.setAttribute('style','display:none;');
var parentNode=obj.parentNode;
var td=document.createElement("td");
td.setAttribute("id", id+"edit");
td.innerHTML='<input id="version"></input><a title="保存" class="fa fa-save fa-fw" herf="javascript:void(0);" onclick="post(\'/domain/deploy\',{domain :\''+id+'\' ,action:1})"></a><a title="取消" class="fa fa-reply-all fa-fw" herf="javascript:void(0);" onclick="cancel(\''+id+'\')"></a>';
parentNode.appendChild(td);
}

function cancel(id)
{
var obj=document.getElementById(id);
obj.setAttribute('style','');
var parentNode=obj.parentNode;
var td=document.getElementById(id+"edit");
parentNode.removeChild(td);
}

function post(url, data){
    var resultid = data["domain"]+"result";
    var obj=document.getElementById(data["domain"]);
    var a=document.createElement("a");
    a.setAttribute("id", resultid)
    
    document.getElementById(resultid).innerHTML='<img src="/static/images/0.gif">';
    var version = document.getElementById("version").value;
    cancel(data["domain"])
    var ajax;
    if(window.XMLHttpRequest){ //Mozilla 浏览器
        ajax = new XMLHttpRequest();
         
        if (ajax.overrideMimeType)
            ajax.overrideMimeType("application/json");
    }
    else if (window.ActiveXObject){ // IE浏览器
        try{
            ajax = new ActiveXObject("Msxml2.XMLHTTP");
        }
        catch (e){
            try{
                ajax = new ActiveXObject("Microsoft.XMLHTTP");
            }
            catch (e) {}
        }
    }   
     
    if (!ajax) { 
        window.alert("不能创建XMLHttpRequest对象实例.");
        return false;
    }
    
    var b = "";
    for (var x in data) {
	b = b+x+"="+data[x]+"&"
    }
    b = b+"version="+version;

    ajax.open("post", url, true);
    ajax.setRequestHeader("contentType","text/html;charset=uft-8") 
    ajax.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
    ajax.send(b);
    ajax.onreadystatechange = function(){
        if (ajax.status == 200){
		document.getElementById(resultid).innerHTML=ajax.responseText;
        }else{
		alert('error');
        }
    }
}
</script>

{% endblock %}
